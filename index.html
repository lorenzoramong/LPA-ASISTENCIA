<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Padel LPA</title>
    <!-- Carga de Tailwind CSS para un diseño moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos personalizados para el botón de estado */
        .status-present {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .status-absent {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .status-pending {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
        }
    </style>
    <!-- Importar SheetJS (xlsx.js) para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen">

    <!-- Encabezado de la Aplicación -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <span class="text-red-600">Asistencia</span> LPA - Liga de Pádel
            </h1>
        </div>
        <!-- Barra de navegación de pestañas -->
        <nav class="border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-4">
                    <a id="tab-registro-btn" href="#" data-tab="registro-asistencia" class="tab-link py-3 px-3 border-b-2 font-medium text-sm text-blue-600 border-blue-600">Registro de Asistencia</a>
                    <a id="tab-reporte-btn" href="#" data-tab="reporte-individual" class="tab-link py-3 px-3 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Reporte Individual</a>
                    <a id="tab-gestion-btn" href="#" data-tab="gestion-academia" class="tab-link py-3 px-3 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Gestión de Academia</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Contenido Principal (Contenedor de Pestañas) -->
    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Nuevo Banner de Estado de Conexión (Se actualiza por JS) -->
        <div id="connection-status-banner" class="p-3 mb-6 rounded-lg text-sm text-center font-medium bg-gray-200 text-gray-800">
            Intentando conectar con la base de datos...
        </div>

        <!-- PESTAÑA 1: REGISTRO DE ASISTENCIA -->
        <div id="registro-asistencia" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Columna de Instrucciones -->
                <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Instrucciones</h2>
                    <p class="text-gray-600 text-sm">
                        Selecciona la **"fecha"** y **"horario"** para tomar la asistencia. Haz click en el botón del estado para cambiarlo entre **"PRESENTE"** y **"AUSENTE"**.
                        Usa la pestaña "Gestión de Academia" para añadir/eliminar jugadores o gestionar horarios.
                    </p>
                    <div id="attendance-message-box" class="mt-4 p-3 rounded-lg text-xs text-center hidden"></div>
                </div>
                <!-- Columna de Asistencia Diaria (Simulación de contenido) -->
                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 1 1 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                        </svg>
                        Asistencia Diaria
                    </h2>
                    <!-- Formulario simulado (Fecha y Horario) -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="fecha" class="block text-xs font-medium text-gray-700">Fecha:</label>
                            <input type="date" id="fecha" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="horario" class="block text-xs font-medium text-gray-700">Horario:</label>
                            <select id="horario" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                <option value="">Seleccionar Horario</option>
                                <!-- Los horarios se cargarán aquí dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <!-- Tabla de Asistencia -->
                    <div class="overflow-x-auto">
                        <table id="attendance-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ALUMNO</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESTADO</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL CLASES</th>
                                </tr>
                            </thead>
                            <tbody id="player-list" class="bg-white divide-y divide-gray-200">
                                <!-- Los datos se cargarán aquí -->
                                <tr><td colspan="3" class="px-3 py-4 text-center text-sm text-gray-400">Esperando conexión...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÑA 2: REPORTE INDIVIDUAL (Oculta por defecto) -->
        <div id="reporte-individual" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Reportes y Exportación</h2>
                <p class="text-gray-600 mb-6">Selecciona un jugador para ver su reporte individual, o exporta el resumen de toda la academia.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Columna de Selección de Jugador -->
                    <div>
                        <label for="select-player-report" class="block text-sm font-medium text-gray-700">Seleccionar Jugador para Reporte:</label>
                        <select id="select-player-report" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <option value="">-- Seleccionar Jugador --</option>
                            <!-- La lista de jugadores cargada de Firestore irá aquí -->
                        </select>
                    </div>

                    <!-- Columna de Exportación a Excel (Ahora centralizada aquí) -->
                    <div class="md:mt-6">
                        <button id="export-excel-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0-3a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm0 4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zM3 3a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                            Descargar Reporte General (Excel)
                        </button>
                    </div>
                </div>

                <!-- Área para mostrar el reporte individual si se selecciona un jugador -->
                <div id="individual-report-area" class="mt-8 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
                    <p class="text-gray-700 text-center">Detalles del Reporte Individual aparecerán aquí.</p>
                </div>
            </div>
        </div>

        <!-- PESTAÑA 3: GESTIÓN DE ACADEMIA (Oculta por defecto) -->
        <div id="gestion-academia" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Bloque 1: Añadir Nuevo Jugador (CON SELECT DE HORARIO) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Añadir Nuevo Jugador</h2>
                    <form id="add-player-form">
                        <div class="mb-4">
                            <label for="player-name" class="block text-sm font-medium text-gray-700">Nombre Completo del Jugador:</label>
                            <input type="text" id="player-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                        </div>
                        <div class="mb-6">
                            <label for="player-schedule" class="block text-sm font-medium text-gray-700">Asignar Horario de Clase:</label>
                            <select id="player-schedule" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                <option value="">-- Seleccionar Horario --</option>
                                <!-- Opciones de horario se cargan aquí -->
                            </select>
                            <p id="schedule-warning" class="text-xs text-red-500 mt-1 hidden">Debes agregar horarios primero en el panel de la derecha.</p>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-200">
                            Guardar Jugador
                        </button>
                    </form>
                    <p id="player-message" class="mt-3 text-sm hidden"></p>
                </div>

                <!-- Bloque 2: Añadir Nuevo Horario -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Añadir Nuevo Horario</h2>
                    <form id="add-schedule-form">
                        <div class="mb-4">
                            <label for="schedule-time" class="block text-sm font-medium text-gray-700">Horario (ej: 18:00 - 19:00):</label>
                            <input type="text" id="schedule-time" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="HH:MM - HH:MM">
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-200">
                            Guardar Horario
                        </button>
                    </form>
                    <p id="schedule-message" class="mt-3 text-sm hidden"></p>
                </div>
            </div>
            
            <!-- LISTADO DE JUGADORES (para editar/eliminar) -->
            <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Jugadores Registrados</h2>
                <div id="registered-players-list" class="space-y-2">
                    <p class="text-gray-500 text-sm">Esperando conexión...</p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==============================================================================
        // *** PASO 1: CONFIGURACIÓN DE FIREBASE (¡Ya configurado para Academia-LPA!) ***
        // ==============================================================================
        const FIREBASE_CONFIG_MANUAL = {
            apiKey: "AIzaSyCR423gNHR_Wb5kE65bSum_R542IJ3cN6I",
            authDomain: "academia-lpa.firebaseapp.com",
            projectId: "academia-lpa",
            storageBucket: "academia-lpa.firebasestorage.app",
            messagingSenderId: "311766682135",
            appId: "1:311766682135:web:c76ca5330cf30132076a52",
            measurementId: "G-194YH0TR6E"
        };
        // Usaremos el projectId como el ID de la aplicación base.
        const APP_ID_STATIC = FIREBASE_CONFIG_MANUAL.projectId || 'padel-lpa-default';

        let app, db, auth;
        let userId = null; // Usaremos la UID generada por signInAnonymously
        let allPlayers = []; 
        let allSchedules = []; 
        let currentAttendanceData = {}; 
        let isFirebaseInitialized = false;

        // Elementos de la UI
        const connectionStatusBanner = document.getElementById('connection-status-banner');
        const playerListBody = document.getElementById('player-list');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const exportExcelBtn = document.getElementById('export-excel-btn'); 
        const playerReportSelect = document.getElementById('select-player-report');
        const registeredPlayersList = document.getElementById('registered-players-list');
        const playerScheduleSelect = document.getElementById('player-schedule'); 
        const scheduleWarning = document.getElementById('schedule-warning');
        
        // Elementos de Asistencia
        const dateInput = document.getElementById('fecha');
        const scheduleSelect = document.getElementById('horario');
        const attendanceMessageBox = document.getElementById('attendance-message-box');
        
        // Formularios de Gestión de Academia
        const addPlayerForm = document.getElementById('add-player-form');
        const addScheduleForm = document.getElementById('add-schedule-form');
        const playerNameInput = document.getElementById('player-name');
        const scheduleTimeInput = document.getElementById('schedule-time');
        const playerMessage = document.getElementById('player-message');
        const scheduleMessage = document.getElementById('schedule-message');


        /**
         * Muestra un mensaje en el banner de estado de la conexión.
         */
        function updateStatusBanner(message, type) {
            connectionStatusBanner.textContent = message;
            connectionStatusBanner.classList.remove('bg-gray-200', 'text-gray-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');

            if (type === 'success') {
                connectionStatusBanner.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                connectionStatusBanner.classList.add('bg-red-100', 'text-red-800');
            } else { // pending/default
                connectionStatusBanner.classList.add('bg-gray-200', 'text-gray-800');
            }
        }

        /**
         * Lógica de inicialización de Firebase
         */
        async function initFirebase() {
            if (!FIREBASE_CONFIG_MANUAL.apiKey) {
                const errMsg = "ERROR: Credenciales de Firebase no configuradas.";
                console.error(errMsg);
                updateStatusBanner(errMsg, 'error');
                return;
            }

            try {
                updateStatusBanner("Intentando conectar con la base de datos...", 'pending');
                
                // 1. Inicializar Firebase con la configuración manual
                app = initializeApp(FIREBASE_CONFIG_MANUAL);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseInitialized = true;
                
                // 2. Autenticar anónimamente (Necesario para usar Firestore)
                // Usamos onAuthStateChanged para obtener el usuario una vez que el estado de auth esté listo.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Mostrar un mensaje claro de que la conexión fue exitosa
                        updateStatusBanner(`Conexión exitosa a Firebase. Usuario: ${userId.substring(0, 8)}...`, 'success');
                        
                        // Cargar datos principales SOLO DESPUÉS de obtener el userId
                        loadSchedules(); 
                        loadPadelPlayers(); 
                    } else {
                        // Si no hay usuario, intentamos firmar anónimamente.
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            updateStatusBanner(`Conexión exitosa a Firebase (Sesión Anónima). Usuario: ${userId.substring(0, 8)}...`, 'success');
                            loadSchedules(); 
                            loadPadelPlayers(); 
                        } catch (anonError) {
                            userId = null;
                            updateStatusBanner(`ERROR: No se pudo conectar a Firebase ni iniciar sesión anónimamente. ${anonError.message}`, 'error');
                            renderPlayersAttendance([]);
                        }
                    }
                });


                setupTabs();
                setupEventListeners();

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                updateStatusBanner(`ERROR de Conexión: ${error.message}`, 'error'); 
            }
        }

        /**
         * Configura los Event Listeners para la funcionalidad de la app.
         */
        function setupEventListeners() {
            // Event Listener para el botón de exportar 
            exportExcelBtn.addEventListener('click', exportToExcel);

            // Event Listeners para la toma de asistencia (Fecha y Horario)
            dateInput.addEventListener('change', loadAttendance);
            scheduleSelect.addEventListener('change', loadAttendance);
            
            // Event Listener para cambio de estado de asistencia (Delegación de eventos)
            playerListBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.status-btn');
                if (btn) {
                    const playerId = btn.closest('tr').dataset.playerId;
                    const currentStatus = btn.dataset.status;
                    
                    if (dateInput.value === "" || scheduleSelect.value === "") {
                        displayMessage(attendanceMessageBox, "ERROR: Debes seleccionar primero la Fecha y el Horario.", 'red');
                        return;
                    }

                    // Determinar el nuevo estado (PRESENTE -> AUSENTE, AUSENTE -> PRESENTE, PENDIENTE -> PRESENTE)
                    let newStatus;
                    if (currentStatus === 'PRESENTE') {
                        newStatus = 'AUSENTE';
                    } else {
                        newStatus = 'PRESENTE'; // Cambia de AUSENTE o PENDIENTE a PRESENTE
                    }

                    // Guardar y actualizar UI
                    saveAttendance(playerId, newStatus);
                    updateAttendanceUI(btn, newStatus); // Optimización visual inmediata
                }
            });


            // Event Listener para añadir jugador
            addPlayerForm.addEventListener('submit', handleAddPlayer);

            // Event Listener para añadir horario
            addScheduleForm.addEventListener('submit', handleAddSchedule);

            // Listener para los botones de eliminar jugadores (Delegación de eventos)
            registeredPlayersList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-player-btn')) {
                    const playerId = e.target.closest('.player-item').dataset.id;
                    if (playerId) {
                         // Usamos window.confirm como alternativa simple a un modal custom
                         if (window.confirm("¿Estás seguro de que deseas eliminar a este jugador? Esta acción es irreversible.")) {
                            handleDeletePlayer(playerId);
                        }
                    }
                }
            });
        }
        
        // --- LÓGICA DE GESTIÓN DE PESTAÑAS ---
        function setupTabs() {
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    const targetTabId = link.dataset.tab;

                    // Ocultar todo el contenido y desactivar todos los enlaces
                    tabContents.forEach(content => content.classList.add('hidden'));
                    tabLinks.forEach(l => {
                        l.classList.remove('text-blue-600', 'border-blue-600');
                        l.classList.add('text-gray-500', 'border-transparent');
                    });

                    // Mostrar el contenido de la pestaña objetivo
                    const targetContent = document.getElementById(targetTabId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }

                    // Activar el estilo del enlace clicado
                    link.classList.add('text-blue-600', 'border-blue-600');
                    link.classList.remove('text-gray-500', 'border-transparent');
                });
            });
        }


        // --- LÓGICA DE EXPORTACIÓN A EXCEL (Reporte General) ---

        /**
         * Exporta el resumen de todos los jugadores a un archivo Excel (.xlsx).
         */
        function exportToExcel() {
            if (allPlayers.length === 0) {
                displayMessage(attendanceMessageBox, "No hay jugadores registrados para exportar.", 'red');
                return;
            }

            // Preparar los datos para la hoja de cálculo
            const data = allPlayers.map(player => {
                const schedule = allSchedules.find(s => s.id === player.scheduleId);
                const scheduleTime = schedule ? schedule.time : 'No Asignado';

                return {
                    'Nombre del Jugador': player.name || 'N/A',
                    'Horario Asignado': scheduleTime,
                    'Total de Clases Asistidas': player.totalClasses || 0,
                };
            });

            try {
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Reporte General");

                const date = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `Reporte_General_LPA_${date}.xlsx`);
                displayMessage(attendanceMessageBox, "Reporte exportado con éxito.", 'green');

            } catch (error) {
                console.error("Error al exportar a Excel:", error);
                displayMessage(attendanceMessageBox, `Error al exportar: ${error.message}`, 'red');
            }
        }


        // --- LÓGICA DE FIREBASE: CARGA DE DATOS PRINCIPALES ---

        /**
         * Carga los datos de los jugadores desde Firestore.
         * La función onSnapshot se mantiene activa y recarga la lista.
         */
        function loadPadelPlayers() {
            if (!db || !userId) {
                renderPlayersAttendance([]);
                return;
            }
            
            // La ruta de la colección respeta las reglas de seguridad: /artifacts/{appId}/users/{userId}/players
            const playersColRef = collection(db, `artifacts/${APP_ID_STATIC}/users/${userId}/players`);

            onSnapshot(playersColRef, (snapshot) => {
                allPlayers = []; 
                snapshot.forEach(doc => {
                    allPlayers.push({ id: doc.id, ...doc.data() });
                });
                
                // Una vez cargados, renderizar y cargar asistencia si hay fecha/horario
                renderPlayersAttendance(allPlayers);
                renderPlayerReportSelect(allPlayers);
                renderRegisteredPlayersList(allPlayers);
                
                // Recargar asistencia si ya hay filtros puestos
                if (dateInput.value && scheduleSelect.value) {
                    loadAttendance(); 
                }

                console.log("Datos de jugadores cargados y actualizados:", allPlayers.length);
            }, (error) => {
                console.error("Error al escuchar jugadores en Firestore:", error);
                playerListBody.innerHTML = `<tr><td colspan="3" class="px-3 py-4 text-center text-sm text-red-500">Error al cargar jugadores: ${error.message}</td></tr>`;
            });
        }

        /**
         * Carga los horarios desde Firestore.
         */
        function loadSchedules() {
            if (!db || !userId) return;

            const schedulesColRef = collection(db, `artifacts/${APP_ID_STATIC}/users/${userId}/schedules`);
            
            // Limpiar selects y cache de horarios
            scheduleSelect.innerHTML = `<option value="">Seleccionar Horario</option>`;
            playerScheduleSelect.innerHTML = `<option value="">-- Seleccionar Horario --</option>`;

            onSnapshot(schedulesColRef, (snapshot) => {
                allSchedules = [];
                snapshot.forEach(doc => {
                    const schedule = { id: doc.id, ...doc.data() };
                    allSchedules.push(schedule);
                });

                // Llenar ambos selects de horarios
                allSchedules.forEach(schedule => {
                    const option1 = document.createElement('option');
                    option1.value = schedule.id; 
                    option1.textContent = schedule.time;
                    scheduleSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = schedule.id; 
                    option2.textContent = schedule.time;
                    playerScheduleSelect.appendChild(option2);
                });
                
                // Mostrar advertencia si no hay horarios para asignar
                if (allSchedules.length === 0) {
                    scheduleWarning.classList.remove('hidden');
                } else {
                    scheduleWarning.classList.add('hidden');
                }
                
                renderRegisteredPlayersList(allPlayers); 

                console.log("Horarios cargados:", allSchedules.length);
            }, (error) => {
                console.error("Error al cargar horarios:", error);
            });
        }

        // --- LÓGICA DE FIREBASE: REGISTRO DE ASISTENCIA ---

        /**
         * Carga la asistencia registrada para la fecha y horario seleccionados.
         */
        function loadAttendance() {
            const date = dateInput.value;
            const scheduleId = scheduleSelect.value;
            
            if (!db || !userId || !date || !scheduleId) {
                // Si falta la fecha o el horario, se asume que no hay datos para cargar.
                currentAttendanceData = {};
                renderPlayersAttendance(allPlayers); // Renderizar con estados PENDIENTE
                return;
            }

            // Documento de asistencia único por (Fecha + Horario)
            const attendanceDocId = `${date}_${scheduleId}`;
            const attendanceDocRef = doc(db, `artifacts/${APP_ID_STATIC}/users/${userId}/attendance`, attendanceDocId);

            // Usamos onSnapshot para mantener el estado en tiempo real
            onSnapshot(attendanceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Los datos de asistencia están anidados en el documento por playerId
                    currentAttendanceData = docSnap.data().records || {};
                    console.log("Asistencia cargada para el periodo:", currentAttendanceData);
                } else {
                    currentAttendanceData = {};
                    console.log("No hay asistencia registrada para este periodo.");
                }
                // Volver a renderizar la lista de jugadores para aplicar la asistencia cargada
                renderPlayersAttendance(allPlayers);
                
            }, (error) => {
                console.error("Error al cargar asistencia:", error);
                displayMessage(attendanceMessageBox, `Error al cargar asistencia: ${error.message}`, 'red');
            });
        }
        
        /**
         * Guarda o actualiza el estado de asistencia de un jugador.
         * @param {string} playerId ID del jugador.
         * @param {('PRESENTE'|'AUSENTE')} status Nuevo estado.
         */
        async function saveAttendance(playerId, status) {
            const date = dateInput.value;
            const scheduleId = scheduleSelect.value;

            if (!db || !userId || !date || !scheduleId) {
                displayMessage(attendanceMessageBox, "ERROR: Debes seleccionar Fecha y Horario.", 'red');
                return;
            }
            
            const attendanceDocId = `${date}_${scheduleId}`;
            const attendanceDocRef = doc(db, `artifacts/${APP_ID_STATIC}/users/${userId}/attendance`, attendanceDocId);
            
            try {
                
                // Si el documento attendanceDocId no existe, se crea con setDoc y merge: true
                await setDoc(attendanceDocRef, { 
                    date: date, 
                    scheduleId: scheduleId, 
                    // Usamos la notación de objeto para crear o actualizar el campo anidado 'records'
                    records: { [playerId]: { status: status, timestamp: new Date() } }
                }, { merge: true });

                
                // TODO: Aquí iría la lógica para actualizar 'totalClasses' del jugador (reporte individual).
                // Esto requeriría una función de contador más compleja para garantizar que no se cuenten doble.
                
                displayMessage(attendanceMessageBox, `Asistencia de ${allPlayers.find(p => p.id === playerId)?.name} marcada como ${status}.`, 'green');

            } catch (error) {
                console.error("Error al guardar asistencia:", error);
                displayMessage(attendanceMessageBox, `Error al guardar asistencia: ${error.message}`, 'red');
            }
        }

        /**
         * Renderiza la lista de jugadores en la tabla de Asistencia.
         * @param {Array<Object>} players Lista de jugadores
         */
        function renderPlayersAttendance(players) {
            // Filtrar jugadores por el horario actualmente seleccionado
            const selectedScheduleId = scheduleSelect.value;
            const playersInSchedule = selectedScheduleId 
                ? players.filter(p => p.scheduleId === selectedScheduleId)
                : players; // Mostrar todos si no hay horario seleccionado
            
            if (playersInSchedule.length === 0) {
                 const message = selectedScheduleId 
                    ? `No hay jugadores asignados al horario seleccionado. Añádelos en "Gestión de Academia".`
                    : `No hay jugadores registrados. Añádelos en "Gestión de Academia".`;

                playerListBody.innerHTML = `<tr><td colspan="3" class="px-3 py-4 text-center text-sm text-gray-500">${message}</td></tr>`;
                return;
            }

            playerListBody.innerHTML = playersInSchedule.map(player => {
                // Obtener el estado de la cache (si existe)
                const record = currentAttendanceData[player.id];
                const status = record ? record.status : 'PENDIENTE';
                const statusClass = status === 'PRESENTE' ? 'status-present' : 
                                    (status === 'AUSENTE' ? 'status-absent' : 'status-pending');

                return `
                    <tr class="hover:bg-gray-100 transition-colors duration-150" data-player-id="${player.id}">
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            <button class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full transition duration-150 hover:opacity-80 status-btn ${statusClass}" data-status="${status}">
                                ${status}
                            </button>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${player.totalClasses || 0}</td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * Actualiza visualmente el botón de estado.
         * @param {HTMLElement} btn El botón de estado (status-btn)
         * @param {('PRESENTE'|'AUSENTE'|'PENDIENTE')} status Nuevo estado
         */
        function updateAttendanceUI(btn, status) {
            btn.textContent = status;
            btn.dataset.status = status;
            btn.classList.remove('status-present', 'status-absent', 'status-pending');
            
            if (status === 'PRESENTE') {
                btn.classList.add('status-present');
            } else if (status === 'AUSENTE') {
                btn.classList.add('status-absent');
            } else {
                btn.classList.add('status-pending');
            }
        }


        // --- LÓGICA DE FIREBASE: GESTIÓN DE ACADEMIA ---

        /**
         * Maneja el envío del formulario para añadir un nuevo jugador, incluyendo el horario.
         */
        async function handleAddPlayer(e) {
            e.preventDefault();
            if (!userId) {
                displayMessage(playerMessage, "Error: La conexión a la base de datos no está lista. Intenta recargar.", 'red');
                return;
            }
            const playerName = playerNameInput.value.trim();
            const scheduleId = playerScheduleSelect.value; 

            if (!playerName || !scheduleId || !db) {
                displayMessage(playerMessage, "Por favor, ingresa nombre y selecciona un horario.", 'red');
                return;
            }

            try {
                const playersColRef = collection(db, `artifacts/${APP_ID_STATIC}/users/${userId}/players`);
                await addDoc(playersColRef, {
                    name: playerName,
                    scheduleId: scheduleId, 
                    totalClasses: 0,
                    createdAt: new Date()
                });

                playerNameInput.value = '';
                playerScheduleSelect.value = '';
                displayMessage(playerMessage, `Jugador "${playerName}" agregado con éxito.`, 'green');

            } catch (error) {
                console.error("Error al añadir jugador:", error);
                displayMessage(playerMessage, `Error al guardar: ${error.message}`, 'red');
            }
        }

        /**
         * Maneja el envío del formulario para añadir un nuevo horario.
         */
        async function handleAddSchedule(e) {
            e.preventDefault();
            if (!userId) {
                displayMessage(scheduleMessage, "Error: La conexión a la base de datos no está lista. Intenta recargar.", 'red');
                return;
            }
            const scheduleTime = scheduleTimeInput.value.trim();

            if (!scheduleTime || !db) {
                displayMessage(scheduleMessage, "Por favor, ingresa un horario válido.", 'red');
                return;
            }

            try {
                const schedulesColRef = collection(db, `artifacts/${APP_ID_STATIC}/users/${userId}/schedules`);
                await addDoc(schedulesColRef, {
                    time: scheduleTime,
                    createdAt: new Date()
                });

                scheduleTimeInput.value = '';
                displayMessage(scheduleMessage, `Horario "${scheduleTime}" agregado con éxito.`, 'green');

            } catch (error) {
                console.error("Error al añadir horario:", error);
                displayMessage(scheduleMessage, `Error al guardar: ${error.message}`, 'red');
            }
        }

        /**
         * Maneja la eliminación de un jugador.
         * @param {string} playerId ID del documento del jugador a eliminar.
         */
        async function handleDeletePlayer(playerId) {
            if (!db || !userId || !playerId) return;
            
            try {
                const playerDocRef = doc(db, `artifacts/${APP_ID_STATIC}/users/${userId}/players`, playerId);
                await deleteDoc(playerDocRef);
                console.log("Jugador eliminado:", playerId);
                displayMessage(playerMessage, "Jugador eliminado con éxito.", 'green');
            } catch (error) {
                console.error("Error al eliminar jugador:", error);
                displayMessage(playerMessage, `Error al eliminar: ${error.message}`, 'red');
            }
        }
        

        // --- LÓGICA DE RENDERIZADO DE UI Y UTILIDADES ---

        /**
         * Renderiza la lista de jugadores en el select de Reporte Individual.
         * @param {Array<Object>} players Lista de jugadores
         */
        function renderPlayerReportSelect(players) {
            playerReportSelect.innerHTML = `<option value="">-- Seleccionar Jugador --</option>`;
            
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name || 'N/A';
                playerReportSelect.appendChild(option);
            });
        }

        /**
         * Renderiza la lista de jugadores en la pestaña Gestión de Academia.
         * @param {Array<Object>} players Lista de jugadores
         */
        function renderRegisteredPlayersList(players) {
            if (players.length === 0) {
                registeredPlayersList.innerHTML = `<p class="text-gray-500 text-sm">No hay jugadores registrados.</p>`;
                return;
            }

            const playerHtml = players.map(player => {
                const schedule = allSchedules.find(s => s.id === player.scheduleId);
                const scheduleTime = schedule ? schedule.time : 'Horario No Asignado';

                return `
                    <div class="player-item flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg" data-id="${player.id}">
                        <div>
                            <span class="font-medium text-gray-800">${player.name}</span>
                            <span class="block text-xs text-gray-500">Horario: ${scheduleTime}</span>
                        </div>
                        <div>
                            <button class="delete-player-btn px-2 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm transition duration-150">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            registeredPlayersList.innerHTML = playerHtml;
        }
        
        /**
         * Muestra un mensaje temporal en la interfaz (éxito/error) para formularios.
         */
        function displayMessage(element, message, type) {
            element.textContent = message;
            element.classList.remove('hidden', 'text-green-600', 'text-red-600', 'bg-red-100', 'bg-green-100');
            element.classList.add(`text-${type}-600`);
            
            // Añadir fondo para mejor visibilidad en el cuadro de asistencia
            if (element === attendanceMessageBox) {
                 element.classList.add(`bg-${type}-100`);
            }
            
            setTimeout(() => {
                element.classList.add('hidden');
                element.classList.remove(`bg-${type}-100`);
            }, 5000);
        }

        // Iniciar la aplicación de Firebase al cargar la página
        window.onload = initFirebase;

    </script>
</body>
</html>





