<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Academia LPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Modal de Login -->
  <div id="login-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded shadow w-80">
      <h2 class="text-lg font-bold mb-4">Iniciar sesión</h2>
      <form id="login-form" class="space-y-4">
        <input id="login-email" type="email" placeholder="Correo" class="w-full border p-2 rounded"/>
        <input id="login-password" type="password" placeholder="Contraseña" class="w-full border p-2 rounded"/>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Entrar</button>
      </form>
      <p id="login-error" class="text-red-500 text-sm mt-2 hidden">Credenciales inválidas</p>
    </div>
  </div>

  <!-- Contenido de la App -->
  <div id="app-content" class="hidden p-6 max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">📋 Academia LPA</h1>
      <button id="logout-btn" class="bg-red-600 text-white px-3 py-1 rounded">Salir</button>
    </div>

    <!-- Pestañas -->
    <div class="mb-4">
      <button onclick="mostrarTab('jugadores')" class="px-4 py-2 bg-gray-200 rounded">Jugadores</button>
      <button onclick="mostrarTab('asistencia')" class="px-4 py-2 bg-gray-200 rounded">Asistencia</button>
    </div>

    <!-- Tab Jugadores -->
    <div id="tab-jugadores" class="tab">
      <h2 class="text-xl font-bold mb-2">Gestión de Jugadores</h2>
      <form id="jugador-form" class="mb-4 space-x-2">
        <input id="input-nombre-jugador" type="text" placeholder="Nombre" class="border p-1 rounded"/>
        <input id="input-apellido-jugador" type="text" placeholder="Apellido" class="border p-1 rounded"/>
        <input id="input-horario" type="text" placeholder="Horario" class="border p-1 rounded"/>
        <button type="submit" class="bg-green-600 text-white px-2 py-1 rounded">Agregar</button>
      </form>
      <table class="w-full border bg-white">
        <thead>
          <tr>
            <th class="border px-2 py-1">Nombre</th>
            <th class="border px-2 py-1">Apellido</th>
            <th class="border px-2 py-1">Horario</th>
            <th class="border px-2 py-1">Acciones</th>
          </tr>
        </thead>
        <tbody id="table-body-jugadores"></tbody>
      </table>
    </div>

    <!-- Tab Asistencia -->
    <div id="tab-asistencia" class="tab hidden">
      <h2 class="text-xl font-bold mb-2">Registro de Asistencia</h2>
      <form id="attendance-form" class="mb-4 space-x-2">
        <select id="select-nombre" class="border p-1 rounded"></select>
        <select id="select-tipo" class="border p-1 rounded">
          <option value="Clase">Clase</option>
          <option value="Torneo">Torneo</option>
        </select>
        <button type="submit" class="bg-green-600 text-white px-2 py-1 rounded">Registrar</button>
      </form>
      <button id="export-csv" class="mb-2 bg-blue-600 text-white px-3 py-1 rounded">⬇️ Exportar CSV</button>
      <table class="w-full border bg-white" id="records-table">
        <thead>
          <tr>
            <th class="border px-2 py-1">Nombre</th>
            <th class="border px-2 py-1">Horario</th>
            <th class="border px-2 py-1">Tipo</th>
            <th class="border px-2 py-1">Fecha</th>
            <th class="border px-2 py-1">Acciones</th>
          </tr>
        </thead>
        <tbody id="table-body-asistencia"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase y lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCR423gNHR_Wb5kE65bSum_R542IJ3cN6I",
      authDomain: "academia-lpa.firebaseapp.com",
      projectId: "academia-lpa",
      storageBucket: "academia-lpa.appspot.com",
      messagingSenderId: "311766682135",
      appId: "1:311766682135:web:c76ca5330cf30132076a52",
      measurementId: "G-194YH0TR6E"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elementos
    const loginModal = document.getElementById("login-modal");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const appContent = document.getElementById("app-content");
    const logoutBtn = document.getElementById("logout-btn");

    const tableBodyJugadores = document.getElementById("table-body-jugadores");
    const tableBodyAsistencia = document.getElementById("table-body-asistencia");
    const selectNombre = document.getElementById("select-nombre");

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // Tabs
    function mostrarTab(tab) {
      document.querySelectorAll(".tab").forEach(t => t.classList.add("hidden"));
      document.getElementById("tab-" + tab).classList.remove("hidden");
    }
    window.mostrarTab = mostrarTab;

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginError.classList.add("hidden");
      } catch {
        loginError.classList.remove("hidden");
      }
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth);
    });

    // Control sesión
    onAuthStateChanged(auth, (user) => {
      if (user && user.email === "ligapadelatlantico@gmail.com") {
        loginModal.style.display = "none";
        appContent.classList.remove("hidden");
        cargarJugadores();
        cargarAsistencia();
      } else {
        loginModal.style.display = "flex";
        appContent.classList.add("hidden");
      }
    });

    // =========================
    // JUGADORES
    // =========================
    async function cargarJugadores() {
      tableBodyJugadores.innerHTML = "";
      selectNombre.innerHTML = '<option value="">Selecciona un jugador...</option>';

      const querySnapshot = await getDocs(collection(db, "jugadores"));
      querySnapshot.forEach(d => {
        const jugador = d.data();
        const id = d.id;

        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td class="border px-2 py-1">${jugador.nombre}</td>
          <td class="border px-2 py-1">${jugador.apellido}</td>
          <td class="border px-2 py-1">${jugador.horario}</td>
          <td class="border px-2 py-1 text-center">
            <button data-id="${id}" class="eliminar bg-red-500 text-white px-2 py-1 rounded text-xs">Eliminar</button>
          </td>
        `;
        tableBodyJugadores.appendChild(fila);

        selectNombre.innerHTML += `<option value="${jugador.nombre} ${jugador.apellido}" data-horario="${jugador.horario}">
          ${jugador.nombre} ${jugador.apellido} - ${jugador.horario}
        </option>`;
      });

      document.querySelectorAll(".eliminar").forEach(btn => {
        btn.addEventListener("click", async e => {
          const id = e.target.dataset.id;
          await deleteDoc(doc(db, "jugadores", id));
          cargarJugadores();
        });
      });
    }

    document.getElementById("jugador-form").addEventListener("submit", async e => {
      e.preventDefault();
      const nombre = document.getElementById("input-nombre-jugador").value.trim();
      const apellido = document.getElementById("input-apellido-jugador").value.trim();
      const horario = document.getElementById("input-horario").value.trim();
      await addDoc(collection(db, "jugadores"), { nombre, apellido, horario });
      e.target.reset();
      cargarJugadores();
    });

    // =========================
    // ASISTENCIA
    // =========================
    async function cargarAsistencia() {
      tableBodyAsistencia.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "asistencia"));
      querySnapshot.forEach(d => {
        const r = d.data();
        const id = d.id;
        const fecha = r.fechaHora?.seconds ? new Date(r.fechaHora.seconds * 1000) : new Date();
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td class="border px-2 py-1">${r.nombre}</td>
          <td class="border px-2 py-1">${r.horario}</td>
          <td class="border px-2 py-1">${r.tipo}</td>
          <td class="border px-2 py-1">${fecha.toLocaleString()}</td>
          ${!isMobile ? `<td class="border px-2 py-1 text-center"><button data-id="${id}" class="eliminar-asistencia bg-red-500 text-white px-2 py-1 rounded text-xs">Eliminar</button></td>` : ""}
        `;
        tableBodyAsistencia.appendChild(fila);
      });

      if (!isMobile) {
        document.querySelectorAll(".eliminar-asistencia").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            if (confirm("¿Seguro que quieres eliminar este registro?")) {
              await deleteDoc(doc(db, "asistencia", id));
              cargarAsistencia();
            }
          });
        });
      }
    }

    document.getElementById("attendance-form").addEventListener("submit", async e => {
      e.preventDefault();
      const jugadorOption = selectNombre.options[selectNombre.selectedIndex];
      const nombre = jugadorOption.value;
      const horario = jugadorOption.dataset.horario;
      const tipo = document.getElementById("select-tipo").value;

      await addDoc(collection(db, "asistencia"), {
        nombre, horario, tipo, fechaHora: new Date()
      });
      e.target.reset();
      cargarAsistencia();
    });

    // =========================
    // EXPORTAR CSV
    // =========================
    document.getElementById("export-csv").addEventListener("click", () => {
      const rows = [["Nombre", "Horario", "Tipo", "Fecha"]];
      document.querySelectorAll("#records-table tbody tr").forEach(tr => {
        const cols = [...tr.querySelectorAll("td")].map(td => td.innerText.trim());
        rows.push(cols.slice(0, 4));
      });

      const SEP = ';';
      const escapeCell = (val) => {
        if (val == null) return '""';
        const s = String(val).replace(/"/g, '""');
        return `"${s}"`;
      };

      const csv = rows.map(row => row.map(cell => escapeCell(cell)).join(SEP)).join('\r\n');
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'asistencia.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>























