<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LPA – Asistencia</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ef4444">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LPA Asistencia">
  <link rel="apple-touch-icon" href="app-icon.png.jpg">
</head>
<body class="bg-red-50">
  <!-- MODAL LOGIN -->
  <!-- Visible por defecto; se ocultará cuando el usuario inicie sesión -->
  <div id="login-modal" class="fixed inset-0 z-50">
    <!-- Fondo gris claro que ocupa toda la pantalla y centra la tarjeta -->
    <div class="absolute inset-0 bg-gray-100 flex items-center justify-center">
      <div class="bg-white p-6 rounded shadow-lg w-80 text-center">
        <!-- LOGO (centrado arriba) -->
        <div class="flex justify-center mb-4">
          <img src="app-icon2.png" alt="Logo LPA" class="w-24 h-24 object-contain">
        </div>

        <h2 class="text-xl font-bold text-red-600 mb-4">Iniciar Sesión</h2>
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-gray-700">Correo</label>
            <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded">
          </div>
          <div>
            <label class="block text-gray-700">Contraseña</label>
            <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded">
          </div>
          <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- APP (oculto hasta iniciar sesión) -->
  <div id="app" class="max-w-3xl mx-auto p-4 hidden">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-red-600">LPA – Asistencia</h1>
      <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Salir</button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 mb-4">
      <button class="tab-button active bg-red-500 text-white px-4 py-2 rounded" data-tab="asistencia-tab">Registro de Asistencia</button>
      <button class="tab-button bg-gray-200 px-4 py-2 rounded" data-tab="jugadores-tab">Jugadores</button>
    </div>

    <!-- TAB 1: Asistencia -->
    <div id="asistencia-tab" class="tab-content">
      <div class="bg-white p-4 rounded shadow mb-4">
        <form id="attendance-form" class="space-y-4">
          <div>
            <label class="block text-gray-700">Jugador</label>
            <select id="select-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded">
              <option value="">Selecciona un jugador...</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700">Estado</label>
            <select id="select-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded">
              <option value="">Selecciona...</option>
              <option value="A tiempo">A tiempo</option>
              <option value="Tarde">Tarde</option>
              <option value="Ausente">Ausente</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded">Registrar</button>
        </form>
      </div>

      <div class="bg-white p-4 rounded shadow mb-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-lg font-semibold text-gray-800">Registros actuales</h2>
          <button id="export-csv" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Exportar CSV</button>
        </div>
        <table id="records-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="bg-red-100">
              <th class="border px-2 py-1">Nombre</th>
              <th class="border px-2 py-1">Horario</th>
              <th class="border px-2 py-1">Tipo</th>
              <th class="border px-2 py-1">Fecha y Hora</th>
              <th class="border px-2 py-1 only-desktop">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- TAB 2: Jugadores -->
    <div id="jugadores-tab" class="tab-content hidden">
      <div class="bg-white p-4 rounded shadow mb-4">
        <form id="jugador-form" class="space-y-4">
          <div>
            <label class="block text-gray-700">Nombre</label>
            <input type="text" id="input-nombre-jugador" required class="w-full px-3 py-2 border border-gray-300 rounded" />
          </div>
          <div>
            <label class="block text-gray-700">Apellido</label>
            <input type="text" id="input-apellido-jugador" required class="w-full px-3 py-2 border border-gray-300 rounded" />
          </div>
          <div>
            <label class="block text-gray-700">Horario</label>
            <input type="text" id="input-horario" required class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="Ej. 17:00 - 19:00" />
          </div>
          <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">Registrar Jugador</button>
        </form>
      </div>

      <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Jugadores Registrados</h2>
        <table id="jugadores-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="bg-red-100">
              <th class="border px-2 py-1">Nombre</th>
              <th class="border px-2 py-1">Apellido</th>
              <th class="border px-2 py-1">Horario</th>
              <th class="border px-2 py-1">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCR423gNHR_Wb5kE65bSum_R542IJ3cN6I",
      authDomain: "academia-lpa.firebaseapp.com",
      projectId: "academia-lpa",
      storageBucket: "academia-lpa.firebasestorage.app",
      messagingSenderId: "311766682135",
      appId: "1:311766682135:web:c76ca5330cf30132076a52",
      measurementId: "G-194YH0TR6E"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM
    const loginModal = document.getElementById("login-modal");
    const appDiv = document.getElementById("app");
    const loginForm = document.getElementById("login-form");
    const logoutBtn = document.getElementById("logout-btn");

    const selectNombre = document.getElementById("select-nombre");
    const tableBodyAsistencia = document.querySelector("#records-table tbody");
    const tableBodyJugadores = document.querySelector("#jugadores-table tbody");
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // UI Tabs
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("bg-red-500","text-white"));
        btn.classList.add("bg-red-500","text-white");
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });

    // LOGIN
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("Error de inicio de sesión: " + error.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // JUGADORES
    async function cargarJugadores() {
      tableBodyJugadores.innerHTML = "";
      selectNombre.innerHTML = '<option value="">Selecciona un jugador...</option>';

      const querySnapshot = await getDocs(collection(db, "jugadores"));
      querySnapshot.forEach(d => {
        const jugador = d.data();
        const id = d.id;

        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td class="border px-2 py-1">${jugador.nombre}</td>
          <td class="border px-2 py-1">${jugador.apellido}</td>
          <td class="border px-2 py-1">${jugador.horario}</td>
          <td class="border px-2 py-1 text-center">
            <button data-id="${id}" class="eliminar bg-red-500 text-white px-2 py-1 rounded text-xs">Eliminar</button>
          </td>
        `;
        tableBodyJugadores.appendChild(fila);

        selectNombre.innerHTML += `<option value="${jugador.nombre} ${jugador.apellido}" data-horario="${jugador.horario}">
          ${jugador.nombre} ${jugador.apellido} - ${jugador.horario}
        </option>`;
      });

      // eventos eliminar jugadores (solo en web)
      document.querySelectorAll(".eliminar").forEach(btn => {
        btn.addEventListener("click", async e => {
          const id = e.target.dataset.id;
          if (confirm("¿Eliminar jugador?")) {
            await deleteDoc(doc(db, "jugadores", id));
            cargarJugadores();
          }
        });
      });
    }

    document.getElementById("jugador-form").addEventListener("submit", async e => {
      e.preventDefault();
      const nombre = document.getElementById("input-nombre-jugador").value.trim();
      const apellido = document.getElementById("input-apellido-jugador").value.trim();
      const horario = document.getElementById("input-horario").value.trim();
      await addDoc(collection(db, "jugadores"), { nombre, apellido, horario });
      e.target.reset();
      cargarJugadores();
    });

    // ASISTENCIA
    async function cargarAsistencia() {
      tableBodyAsistencia.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "asistencia"));
      querySnapshot.forEach(d => {
        const r = d.data();
        const id = d.id;
        const fecha = r.fechaHora?.seconds ? new Date(r.fechaHora.seconds * 1000) : new Date(r.fechaHora);
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td class="border px-2 py-1">${r.nombre}</td>
          <td class="border px-2 py-1">${r.horario}</td>
          <td class="border px-2 py-1">${r.tipo}</td>
          <td class="border px-2 py-1">${fecha.toLocaleString()}</td>
          ${!isMobile ? `<td class="border px-2 py-1 text-center"><button data-id="${id}" class="eliminar-asistencia bg-red-500 text-white px-2 py-1 rounded text-xs">Eliminar</button></td>` : ""}
        `;
        tableBodyAsistencia.appendChild(fila);
      });

      if (!isMobile) {
        document.querySelectorAll(".eliminar-asistencia").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            if (confirm("¿Seguro que quieres eliminar este registro?")) {
              await deleteDoc(doc(db, "asistencia", id));
              cargarAsistencia();
            }
          });
        });
      }
    }

    document.getElementById("attendance-form").addEventListener("submit", async e => {
      e.preventDefault();
      const jugadorOption = selectNombre.options[selectNombre.selectedIndex];
      const nombre = jugadorOption.value;
      const horario = jugadorOption.dataset.horario;
      const tipo = document.getElementById("select-tipo").value;

      await addDoc(collection(db, "asistencia"), {
        nombre, horario, tipo, fechaHora: new Date()
      });
      e.target.reset();
      cargarAsistencia();
    });

    // EXPORTAR CSV (desktop y móvil)
    document.getElementById("export-csv").addEventListener("click", () => {
      const rows = [["Nombre", "Horario", "Tipo", "Fecha"]];
      document.querySelectorAll("#records-table tbody tr").forEach(tr => {
        const cols = [...tr.querySelectorAll("td")].map(td => td.innerText.trim());
        rows.push(cols.slice(0, 4));
      });

      const SEP = ';';
      const escapeCell = (val) => {
        if (val == null) return '""';
        const s = String(val).replace(/"/g, '""');
        return `"${s}"`;
      };

      const csv = rows.map(row => row.map(cell => escapeCell(cell)).join(SEP)).join('\r\n');
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'asistencia.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // CONTROL DE SESIÓN: mostrar app solo cuando hay usuario
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginModal.classList.add("hidden");
        appDiv.classList.remove("hidden");
        // cargar datos al iniciar sesión
        cargarJugadores();
        cargarAsistencia();
      } else {
        appDiv.classList.add("hidden");
        loginModal.classList.remove("hidden");
      }
    });

    // Registrar service worker si aplica
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(()=>{/* ignore */});
    }
  </script>

  <style>
    @media (max-width: 768px) {
      .only-desktop {
        display: none;
      }
    }
  </style>
</body>
</html>





























